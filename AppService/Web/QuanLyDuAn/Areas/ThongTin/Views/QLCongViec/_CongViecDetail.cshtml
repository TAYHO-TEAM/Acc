@model int
<form id="form-regist" action="#" method="POST" enctype="application/json">
</form>
<script>

    var formData = {
        "planScheduleCommandSet": {
            "planMasterId": 0,
            "planJobId": 0,
            "title": "",
            "note": "",
            "remind": "",
            "repead": 0,
            "repeadType": "",
            "startDate": "",
            "endDate": "",
            "modifyTimes": 0,
            "id": 0,
            "isActive": true,
            "isVisible": true,
            "status": 0
        },
        "code": ""
        , "parentId": ""
        , "planProjectId": 3
        , "title": ""
        , "timeLine": ""
        , "description": ""
        , "note": ""
        , "startDate": ""
        , "endDate": ""
        , "unit": ""
        , "amount": ""
        , "reportPeriodicalType": ""
        , "reportPeriodical": ""
        , "reportFrequency": ""
        , "priority": ""
        , "importantLevel": 0
        , "noAttachment": ""
        , "isDelete": ""
        , "isActive": ""
        , "isVisible": ""
        , "isModify": ""
        , "createBy": ""
        , "createDateUTC": ""
        , "createDate": ""
        , "modifyBy": ""
        , "updateDateUTC": ""
        , "updateDate": ""
        , "status": ""

    };

    $(document).ready(function () {
            var params = {
            'PageSize': 0,
            'PageNumber': 0,
            'FindId': @Model,
        }
        $.ajax({
            headers: header,
            url: URL_API_PM_READ + ACTION,
            dataType: "json",
            data: params,
            async: false,
            success: function (data) {
                let list = data.result.items;
                formData = {
                    "planRegisterId": list[0].planRegisterId
                    , "documentTypeId": list[0].documentTypeId
                    , "workItemId": list[0].workItemId
                    , "title": list[0].title
                    , "descriptions": list[0].descriptions
                    , "note": list[0].note
                };
            },
            complete: function (e) {
                 var formInstance = $("#form-regist").dxForm({
                            formData: formData,
                            labelLocation: "top",
                            items: [
                                 {
                                     dataField: "code",
                                     label: { text: "Mã CV" },
                                     editorOptions: {
                                         stylingMode: "filled",
                                         placeholder: "Vui lòng nhập...",
                                     }
                                 },
                                 {
                                     dataField: "title",
                                     colSpan: 2,
                                     label: { text: "Tên công việc" },
                                     validationRules: [{ type: "required" }],
                                     editorOptions: {
                                         stylingMode: "filled",
                                         placeholder: "Vui lòng nhập...",
                                     }
                                 },
                                 {
                                     dataField: "importantLevel",
                                     caption: "Mức độ quan trọng",
                                     dataType: "number",
                                     lookup: {
                                         dataSource: important,
                                         valueExpr: "ID",
                                         displayExpr: "Name",
                                     },
                                     editorType: "dxSelectBox",
                                     editorOptions: {
                                         stylingMode: "filled",
                                         placeholder: "Vui lòng chọn...",
                                         value: "importantLevel",
                                         dataSource: important,
                                         valueExpr: "ID",
                                         displayExpr: "Name",
                                     },
                                 },
                                 {
                                     colSpan: 4,
                                     dataField: "description",
                                     label: { text: "Mô tả CV" },
                                     editorType: "dxTextArea",
                                     editorOptions: {
                                         stylingMode: "filled",
                                         placeholder: "Vui lòng nhập...",
                                     }
                                 },
                                 {
                                     colSpan: 2,
                                     dataField: "endDate",
                                     label: { text: "Ngày hoàn thành" },
                                     editorType: "dxDateBox",
                                     editorOptions: {
                                         stylingMode: "filled",
                                         placeholder: "Vui lòng nhập...",
                                         pickerType: "rollers",
                                         type: "datetime",
                                     },
                                 },
                                 {
                                     colSpan: 2,
                                     template: '<span class="dx-field-item-label-text font-bold">Các tập tin đính kèm</span><div class="file-uploader"></div>',
                                 },
                                 {
                                     colSpan: 4,
                                     itemType: "button",
                                     horizontalAlignment: "center",
                                     buttonOptions: {
                                         text: "Lưu lại",
                                         icon: "fa fa-save",
                                         type: "success",
                                         useSubmitBehavior: true,
                                         elementAttr: {
                                             id: "submit",
                                         }
                                     }
                                 },
                             ],
                            onFieldDataChanged: function (e) {
                                var newFormData = e.component.option("formData");
                            }
                        }).dxForm("instance");
            },
        });
        $(".file-uploader").dxFileUploader({
            selectButtonText: "Chọn tập tin...",
            labelText: "Hoặc kéo thả vào đây",
            showFileList: true,
            multiple: true,
            uploadMode: "useForm",
            allowedFileExtensions: [".jpg", ".jpeg", ".png", ".pdf", ".doc", ".docx"],
            maxFileSize: 10000000,
        });
        $("#form-regist").on("submit", function (e) {
            loadingPanel.show();
            $(this).prop("disabled", true);
            var fdata = new FormData();
            var i = 10;
            $.each(formData, function (key, value) {
                if (key === 'startDate' || key === 'endDate') {
                    fdata.append(key, moment(value).format('YYYY-MM-DD HH:mm:ss'));
                }
                else {
                    fdata.append(key, value);
                }

            });
            fdata.append('planProjectId', 3);
            fdata.append('token', UserCurrentInfo.accessToken);
            //for (var pair of fdata.entries()) {
            //    console.log(pair[0] + ', ' + pair[1]);
            //}
            var files = $(".file-uploader").dxFileUploader("instance").option("value");
            if (files.length > 0) {
                $.each(files, function (key, value) {
                    fdata.append(files[key].name, files[key]);
                });
            }
            //else {
            //    DevExpress.ui.notify("Vui lòng chọn file đính kèm", "error", 3000);
            //    e.preventDefault();
            //    return false;
            //};
            e.preventDefault();

            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "/ThongTin/QLCongViec/Create",
                data: fdata,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (rs) {
                    loadingPanel.hide();
                    DevExpress.ui.notify(rs.result, rs.status, 3000);
                    if (rs.status == "success") {
                        $("#popup-main").dxPopup('instance').hide();
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    loadingPanel.hide();
                    DevExpress.ui.notify("Có lỗi xảy ra: " + errorThrown, "error", 3000);
                }
            });
            e.preventDefault();
            //return deferred.promise();
        });

    });


</script>

