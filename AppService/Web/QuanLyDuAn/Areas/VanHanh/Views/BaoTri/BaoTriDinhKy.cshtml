
@{
    ViewBag.Title = "BaoTriDinhKy";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section style{   }
<div id="popup-main-upload"></div>
<div id="popup-register"></div>
<div class="row">
    <div class="col-4" id="cont-left">
        <div id="container" class="elevation-2"></div>
    </div>
    <div class="col-8" id="cont-right" >
        <div id="container-maintenancelog-detail" class="elevation-2" style="height:100%">
            <div class="card card-success" style="height:100%">
                <div class="card-header ui-sortable-handle" style="cursor: move;" id="card-header">
                    <h3 class="card-title">Lưu thông tin bảo trì</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div id="container-resolve" class="elevation-2 card-body" style="overflow-y: auto;">
                    <form id="form-maintenancelog-detail" action="#" method="POST" enctype="application/json">
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
@section script{
    <script src="~/Scripts/page/vanhanh.js"></script>
    <script>

        ///-----------------------------READ ------------------------
        var ACTION_MAINTENANCESCHEDULE = "MaintenanceSchedule/";
        var ACTION_MAINTENANCELOG = "MaintenanceLog/";
        var ACTION_MAINTENANCESUPPLIERINFO = "MaintenanceSupplierInfo/";
        var ACTION_MAINTENANCERINFO = "MaintenancerInfo/";
        var ACTION_PROJECT = "Project/";
        var ACTION_CUSTOMERINFO = "CustomerInfo/";
        var ACTION_CONSTRUCTIONITEMS = "ConstructionItems/";
        var ACTION_CUSTOMERREALESTATE = "CustomerRealEstate/";
        var ACTION_COMPLAINTSTYPE = "ComplaintsType/";
        var ACTION_COMPLAINTRESOLVE = "ComplaintResolve/";
        var ACTION_REALESTATE = "RealEstate/";
        var ACTION_FILESATTACHMENT = "FilesAttachment/";
        var KEY = "id";
        var WIDTH_CONTAINER = $("#container").width(); 
        var $today = moment(Date.now()).format('YYYY-MM-DD HH:mm:ss');
        console.log($today);
        //..........................Get data -------------------------------------------------------------

        var customStore = () => new DevExpress.data.DataSource({
            store: $DATASOURCEGET(ACTION_MAINTENANCELOG, KEY),
            filter: ["isActive", "=", true]
        });
        var customStore_MaintenanceScheduleById = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCE(ACTION_MAINTENANCESCHEDULE, KEY),
            filter: ["id", "=", id]
        });

        var customStore_MaintenanceSupplierInfo = () => new DevExpress.data.DataSource({
            store: $DATASOURCEGET(ACTION_MAINTENANCESUPPLIERINFO, KEY),
        });
        var customStore_MaintenancerInfo = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCEGET(ACTION_MAINTENANCERINFO, KEY),
            filter: ["maintenanceSupplierInfoId", "=", id]
        });
        var customStore_MaintenancerInfoById = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCEGET(ACTION_MAINTENANCERINFO, KEY),
            filter: ["id", "=", id]
        });
        var customStore_MaintenanceLog = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCE(ACTION_MAINTENANCELOG, KEY),
            filter: ["maintenanceScheduleId", "=", id]
        });
        var customStore_MaintenanceLogById = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCE(ACTION_MAINTENANCELOG, KEY),
            filter: ["id", "=", id]
        });
        var customStore_ById = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCE(ACTION_COMPLAINT, KEY),
            filter: ["id", "=", id]
        });
        var customStore_ComplaintResolve = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCE(ACTION_COMPLAINTRESOLVE, KEY),
            filter: ["complaintId", "=", id]
        });
        var customStore_CustomerInfo = $DATASOURCEGET(ACTION_CUSTOMERINFO, KEY);
        var customStore_RealEstate = $DATASOURCEGET(ACTION_REALESTATE, KEY);
        var customStore_ComplaintsType = $DATASOURCEGET(ACTION_COMPLAINTSTYPE, KEY);
        var customStore_ConstructionItems = $DATASOURCEGET(ACTION_CONSTRUCTIONITEMS, KEY);
        var customStore_CustomerRealEstate = (id) => new DevExpress.data.DataSource({
            store: $DATASOURCEGET(ACTION_CUSTOMERREALESTATE, KEY),
            filter: ["realEstateId", "=", id]
        });
        var customStore_Attachment = (id, owner) => new DevExpress.data.DataSource({
            store: $DATASOURCE(ACTION_FILESATTACHMENT, KEY),
            filter: [["ownerById", "=", id], "and", ["ownerByTable", "=", owner]]
        });
        var $constructionItemsId = 0;
        var $currentMaintenanceSupplierInfoId = 0;
        var $currentMaintenancerInfoId = 0;
        var $currentMaintenanceLogStatus = 0;
        var formData = {
            "code": "",
            "barcode": "",
            "priority": 0,
            "constructionItemsId": 0,
            "maintenancerInfoId": 0,
            "maintenanceSupplierInfoId": 0,
            "maintenanceScheduleId": 0,
            "maintaincerName": "",
            "maintaincerPhone": "",
            "note": "",
            "result": "",
            "resultType": "",
            "currentTimes": "",
            "times": "",
            "startTime": "",
            "endTime": "",
            "duration": "",
            "durationUnit": "",
            "durationUnitType": "",
            "type": "",
            "noAttachment": "",
            "status": 0
        };
        var $defectFixId = 0;
        var fdata = new FormData();
        var $maintenanceSupplierInfoId = 0;
        var $dataSource = {};
        var $currentConstructionItemsId = 0;
        //..........................Function -------------------------------------------------------------
        $(function () {
            loadData();
        });

        var loadData = () => {
            $("#cont-right").hide(); 
            $("#container").dxDataGrid({
                height: heightScreen,
                dataSource: customStore(),
                repaintChangesOnly: true,
                remoteOperations: true,
                scrolling: { mode: "standard" },
                showBorders: false,
                showColumnHeaders: true,
                showColumnLines: false,
                hoverStateEnabled: true,
                showRowLines: true,
                columnAutoWidth: true,
                wordWrapEnabled: true,
                rowAlternationEnabled: true,
                filterRow: { visible: true },
                summary: {
                    groupItems: [{
                        column: "status",
                        summaryType: "count"
                    },
                    ]
                },
                paging: {
                    enabled: true,
                    pageSize: 20
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 20, 40],
                    showInfo: true,
                },
                searchPanel: {
                    highlightCaseSensitive: true,
                    highlightSearchText: true,
                    searchVisibleColumnsOnly: true,
                    visible: WIDTH_CONTAINER > 350
                },
                onToolbarPreparing: function (e) {
                    var container = e.component;
                    e.toolbarOptions.items.unshift(
                        {
                            location: "after",
                            widget: "dxButton",
                            options: {
                                icon: "refresh",
                                stylingMode: "filled",
                                type: "default",
                                onClick: () => container.refresh()
                            },

                        },

                    )
                },
                onInitNewRow: (e) => {
                    e.data.isActive = true;
                    e.data.isVisible = true;
                    e.data.constructionItemsId = CUNSTRITEMS;
                },
                onRowUpdating: (e) => {
                },
                onCellPrepared: (e) => {
                    if (e.rowType == "data" && e.columnIndex == 1)
                        e.cellElement.find('.dx-treelist-empty-space').toggleClass("dx-treelist-collapsed", e.data.chilCount > 0)
                },
                onRowDblClick: function (e) {
                    var container = e.component;
                },
                selection: {
                    mode: "single"
                },
                onContentReady: (e) => {
                    var container = e.component;
                },
                onSelectionChanged: (e) => {
                    var container = e.component;
                    var selectedRowData = e.selectedRowsData[0];
                    var selectedRowKey = e.selectedRowKeys[0];
                    loadData_MaintenanceLogDetail(selectedRowKey);
                },
                onContextMenuPreparing: function (e) {
                    var container = e.component;
                  
                    if (!e.items) e.items = [];
                    if (e.target == "content" && e.rowIndex >= 0) {
                        e.items.push({
                            icon: "fas fa-clipboard-list",
                            text: e.row.data.status >= 10 ? "Cập nhật phiếu hẹn" : "Tạo phiếu hẹn",
                            onItemClick: () => {
                                CALLPOPUP(
                                    "Phiếu xuất kho",
                                    "/VanHanh/BaoTri/_PhieuHenBaoTriCreate?id=" + e.row.data.id,
                                    ($(window).width() > 767 ? "50%" : "80%"),
                                    container
                                );
                            }
                        });

                    };
                },
                columns: [
                    {
                        dataField: "constructionItemsId",
                        allowFiltering: true,
                        caption: "Hệ thống",
                        dataType: "string",
                        alignment: "center",
                        lookup: {
                            dataSource: customStore_ConstructionItems,
                            valueExpr: "id",
                            displayExpr: "title",
                        },
                    },// address
                    {
                        dataField: "maintenanceSupplierInfoId",
                        allowFiltering: true,
                        caption: "Đơn vị BT",
                        dataType: "number",
                        alignment: "center",
                        lookup: {
                            dataSource: customStore_MaintenanceSupplierInfo().store(),
                            valueExpr: "id",
                            displayExpr: "name",
                        },
                    },// address
                    {
                        dataField: "startTime",
                        allowFiltering: true,
                        caption: "Ngày BT",
                        alignment: "center",
                        dataType: "date",
                    },// address
                    {
                        dataField: "status",
                        allowFiltering: true,
                        caption: "Tình trang",
                        alignment: "center",
                        editorType: "dxSwitch",
                        showWhenGrouped: true,
                    },// Trạng thái
                ],
                editing: {
                    allowAdding: false,
                    allowUpdating: false,
                    allowDeleting: false,
                    mode: "rown",
                    useIcons: true,
                    confirmDelete: true,
                    popup: {
                        width: "30%",
                        height: "45%",
                        showTitle: true,
                        title: "Thêm căn hộ mới",
                        closeOnOutsideClick: false,
                        showCloseButton: true,
                    },

                },
            });
        };
        var loadData_MaintenanceLogDetail = (id) => {
            $("#cont-right").show(); 
            //document.getElementById('cont-right').style.width = document.getElementById('cont-left').clientHeight;
            var $heightForm = (document.getElementById('cont-left').clientHeight) - (document.getElementById('card-header').clientHeight)*3;
            //document.getElementById('container-resolve').style.width = $heightForm;
            customStore_MaintenanceLogById(id).load().done((rs) => {
                $issetRS = (rs.length > 0);
                console.log($issetRS);
                if ($issetRS) {
                    $keyRS = rs[0].id;
                }
                //else {
                //    var cptId = $('#elementComplaintTypeId').dxSelectBox('instance').option('value');;
                //    console.log(cptId);
                //    customStore_ComplaintsType.load().done((rs) => {
                //        var item = rs.filter(x => x.id == cptId).shift();
                //        $('#elementNoteResolve').dxTextArea('instance')
                //            .option('value', item == null ? "" : (item.resolveSuggest));
                //    });

                //}
                $("#form-maintenancelog-detail").dxForm({
                    formData: rs[0],
                    height: $heightForm,
                    labelLocation: "top",
                    items: [
                        {
                            itemType: "group",
                            colCount: 12,
                            cssClass: "first-group",
                            items: [
                                {
                                    colSpan: 4,
                                    dataField: "constructionItemsId",
                                    label: { text: "Hạng mục" },
                                    editorType: "dxSelectBox",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        readOnly: true,
                                        placeholder: "Vui lòng chọn...",
                                        dataSource: customStore_ConstructionItems,
                                        valueExpr: "id",
                                        displayExpr: 'title',
                                    },
                                },
                                {
                                    colSpan: 4,
                                    dataField: "maintenanceSupplierInfoId",
                                    label: { text: "Đơn vị Bảo trì" },
                                    type: "string",
                                    editorType: "dxSelectBox",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        dataSource: customStore_MaintenanceSupplierInfo().store(),
                                        readOnly: true,
                                        valueExpr: "id",
                                        displayExpr: "name",
                                        elementAttr: {
                                            id: "elementMaintenanceSupplierInfoId",
                                        },
                                    },
                                    validationRules: [{ type: "required" }],
                                },
                                {
                                    colSpan: 4,
                                    dataField: "maintaincerName",
                                    label: { text: "Nhân viên kỹ thuật" },
                                    visible: true,
                                    editorType: "dxTextBox",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        readOnly: true,
                                        elementAttr: {
                                            id: "elementMaintaincerName",
                                        },
                                    },
                                    validationRules: [{ type: "required" }],
                                },
                                {
                                    colSpan: 4,
                                    dataField: "maintaincerPhone",
                                    label: { text: "Số ĐT Liên hệ" },
                                    editorType: "dxTextBox",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        readOnly: true,
                                        elementAttr: {
                                            id: "elementMaintaincerPhone",
                                        },
                                    },
                                    validationRules: [{ type: "required" }],
                                },
                                {
                                    colSpan: 4,
                                    dataField: "startTime",
                                    label: { text: "Dự kiến bảo trì" },
                                    editorType: "dxDateBox",
                                    type: "datetime",
                                    editorOptions: {
                                        readOnly: true,
                                        stylingMode: "filled",
                                    },
                                    validationRules: [{ type: "required" }],
                                },
                                {
                                    colSpan: 4,
                                    dataField: "endTime",
                                    label: { text: "Dự kiến hoàn thành" },
                                    editorType: "dxDateBox",
                                    type: "datetime",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        readOnly: true,
                                    },
                                    validationRules: [{ type: "required" }],
                                },
                            ]
                        },
                        {
                            itemType: "group",
                            name: "save-note-action",
                            visible: rs[0].status < 11 ? false : true,
                            colCount: 12,
                            items: [
                                {
                                    colSpan: 12,
                                    dataField: "note",
                                    label: { text: "Ghi nhận quá trình" },
                                    editorType: "dxTextArea",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        height: 100,
                                        elementAttr: {
                                            id: "elementNote",
                                        },
                                    },
                                },
                            ],
                        },
                        {
                            itemType: "group",
                            name: "save-note-action",
                            colCount: 12,
                            visible: rs[0].status < 11 ? false : true,
                            items: [
                                {
                                    colSpan: 12,
                                    dataField: "result",
                                    label: { text: "Ghi nhận kết quả" },
                                    editorType: "dxTextBox",
                                    editorOptions: {
                                        stylingMode: "filled",
                                        elementAttr: {
                                            id: "elementResult",
                                        },
                                    },
                                },
                            ],
                        },
                        //{
                        //    itemType: "simple",
                        //    name: "Image",
                        //    visible: rs[0].status < 11 ? false : true,
                        //    editorType: 'dxGallery',
                        //    editorOptions: {
                        //        stylingMode: "filled",
                        //        dataSource: customStore_Attachment(rs[0].id, "MaintenanceLog"),
                        //        height: 100,
                        //        width: 'auto',
                        //        slideshowDelay: 1500,
                        //        itemTemplate: function (data) {
                        //            return $("<img />").attr({ "src": (data.host + data.url + "/" + data.fileName), onerror: ImgError(this), "style": "max-height: 200px; height : auto ;width : fit-content ;margin: auto;" });
                        //        },
                        //        onItemClick: function (value) {
                        //        }
                        //    },

                        //},
                        {
                            colSpan: 12,
                            template: () => {
                                var scrollView = $("<div id='scrollView'></div>");
                                var content = $("<div/>");
                                content.dxDataGrid({
                                    dataSource: customStore_Attachment(rs[0].id, "MaintenanceLog"),
                                    remoteOperations: {
                                        paging: true,
                                        sorting: true,
                                    },
                                    repaintChangesOnly: true,
                                    showBorders: true,
                                    showColumnHeaders: true,
                                    showColumnLines: false,
                                    hoverStateEnabled: true,
                                    showRowLines: true,
                                    columnAutoWidth: true,
                                    wordWrapEnabled: true,
                                    wordWrapEnabled: true,
                                    rowAlternationEnabled: true,
                                    paging: {
                                        enabled: true,
                                        pageSize: 20
                                    },
                                    pager: {
                                        showPageSizeSelector: true,
                                        allowedPageSizes: [10, 20, 40],
                                        showInfo: true,

                                    },
                                    columns: [
                                        {
                                            caption: "STT", alignment: "center",
                                            cellTemplate: (c, o) => $("<div/>").append(o.rowIndex + 1).appendTo(c),
                                            width: '10%',
                                        },
                                        {
                                            dataField: "fileName",
                                            caption: "Tên file",
                                            dataType: "string",
                                            width: '50%',
                                        },//rev
                                        {
                                            caption: "File",
                                            dataType: "string",
                                            cellTemplate: (c, o) => {
                                                var x = (o.data.host + "\\" + o.data.url + "\\" + o.data.fileName).replaceAll('/', '\\');
                                                if (!x.includes('null'))
                                                    if (['.png', '.jpg', '.jpge'].includes(o.data.tail.toLowerCase(x))) {

                                                        $("<a/>").append($("<img/>").attr("src", x).attr("style", "max-width :150px;").attr("onerror", "this.onerror=null;this.src='https://qlcv.tayho.com.vn/Content/user-avartar/avartar-default.jpg';")).appendTo(c);
                                                    }
                                                    else if (['.pdf'].includes(o.data.tail.toLowerCase(x))) {
                                                        $("<a/>").attr("href", x).addClass("far fa-file-pdf").appendTo(c);
                                                    }
                                                    else {
                                                    }
                                            },
                                        }, //url
                                    ],
                                    editing: {
                                        mode: "batch",
                                        allowAdding: false,
                                        allowDeleting: true,
                                        allowUpdating: false,
                                    },
                                    onToolbarPreparing: (e) => {
                                        var container = e.component;
                                        e.toolbarOptions.items.unshift(
                                            {
                                                location: "after", widget: "dxButton",
                                                options: {
                                                    icon: "refresh", type: "default",
                                                    onClick: () => container.refresh()
                                                }
                                            })
                                    },
                                });
                                scrollView.append(content);
                                //c.append(scrollView);
                                return scrollView;
                            },
                            editorOptions: {
                                stylingMode: "filled",
                            }
                        },
                        {
                            colSpan: 12,
                            template: rs[0].status >= 11 ? '<span class="dx-field-item-label-text font-bold">Các tập tin đính kèm</span><div class="file-uploader" id="file-uploader"></div>' : '',
                            editorOptions: {
                                stylingMode: "filled",
                            }
                        },
                        {
                            itemType: "group",
                            name: "button-action",
                            colCount: 12,
                            items: [
                                {
                                    colSpan: 12,
                                    itemType: "button",
                                    horizontalAlignment: "center",
                                    disabled: id == 0,
                                    visible: rs[0].status >= 11 ? false : true,
                                    buttonOptions: {
                                        text: "Bắt đầu bảo trì",
                                        icon: "fa fa-play",
                                        type: "default",
                                        //useSubmitBehavior: true,
                                        elementAttr: {
                                            id: "start",
                                        },
                                        editorOptions: {
                                            stylingMode: "contained",
                                            cssClass: "bg-info",
                                        }
                                    }
                                },
                                {
                                    colSpan: 6,
                                    itemType: "button",
                                    horizontalAlignment: "right",
                                    disabled: id == 0,
                                    visible: rs[0].status < 11 ? false : true,
                                    buttonOptions: {
                                        text: "Cập nhật",
                                        icon: "fa fa-check",
                                        type: "default",
                                        //useSubmitBehavior: true,
                                        elementAttr: {
                                            id: "updateLog",
                                        },
                                        editorOptions: {
                                            stylingMode: "contained",
                                            cssClass: "bg-info",
                                        }
                                    }
                                },
                                {
                                    colSpan: 6,
                                    itemType: "button",
                                    horizontalAlignment: "left",
                                    disabled: id == 0,
                                    visible: rs[0].status < 11 ? false : true,
                                    buttonOptions: {
                                        text: "Nghiệm thu",
                                        icon: "fa fa-clipboard",
                                        type: "default",
                                        elementAttr: {
                                            id: "acceptence",
                                        },
                                        editorOptions: {
                                            stylingMode: "contained",
                                            cssClass: "bg-info",
                                        }
                                    }
                                },
                            ],
                        },
                    ],
                }).dxForm("instance");
                fileUploader();
                $(document).on('click', '#start', function (e) {
                    //$("#form-maintenancelog").on("submit", function (e) {
                    e.preventDefault();
                    var formdata = $('#form-maintenancelog-detail').dxForm("instance").option('formData');
                    var resValid = true
                    if (!resValid) {
                        DevExpress.ui.notify("Vui lòng kiểm tra lại file đính kèm!", "error", 3000);
                    }
                    else {
                        loadingPanel.show();
                        var deferred = $.Deferred();
                        formdata.status = 11;
                        formdata.maintenanceScheduleId = rs[0].maintenanceScheduleId;
                        formdata.maintenancerInfoId = rs[0].maintenancerInfoId;
                        formdata.currentTimes = $today;
                        if (id > 0) {
                            customStore_MaintenanceLog(0).store().update(id, formdata).done((rs) => {
                                loadingPanel.hide();
                                if (rs.isOk) {
                                    deferred.resolve(rs);
                                    DevExpress.ui.notify("Cập nhật thành công", "success", 3000);
                                }
                                else {
                                    DevExpress.ui.notify("Có lỗi xảy ra", "error", 3000);
                                    deferred.resolve(false);
                                }
                            }, deferred.reject)
                        }

                        return deferred.promise();
                    }
                });
                $(document).on('click', '#updateLog', function (e) {
                    e.preventDefault();
                    var formdata = $('#form-maintenancelog-detail').dxForm("instance").option('formData');
                    var files = $("#file-uploader").dxFileUploader("instance").option("value");
                 
                    var fileWrappers = fileUploader()._files;
                    var resValid = true
                    if (!resValid) {
                        DevExpress.ui.notify("Vui lòng kiểm tra lại file đính kèm!", "error", 3000);
                    }
                    else {
                        loadingPanel.show();
                        var deferred = $.Deferred();
                        formdata.status = 11;
                        formdata.maintenanceScheduleId = rs[0].maintenanceScheduleId;
                        formdata.maintenancerInfoId = rs[0].maintenancerInfoId;
                        var fdata = new FormData();
                        var i = 10;
                        $.each(formdata, function (key, value) {
                            fdata.append(key, value);
                        });
                        fdata.append('key', id);
                        fdata.append('token', UserCurrentInfo.accessToken);
                        var files = $("#file-uploader").dxFileUploader("instance").option("value");
                        if (files.length > 0) {
                            $.each(files, function (key, value) {
                                fdata.append(files[key].name, files[key]);
                            });
                        }
                        if (id > 0) {
                            $.ajax({
                                type: "POST",
                                enctype: 'multipart/form-data',
                                url: "/VanHanh/BaoTri/MaintenanceLogUpdate",
                                data: fdata,
                                processData: false,
                                contentType: false,
                                cache: false,
                                success: function (rs) {
                                    deferred.resolve(true);
                                    loadingPanel.hide();
                                    DevExpress.ui.notify(rs.result, rs.status, 3000);
                                    loadData_MaintenanceLogDetail(id);
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    loadingPanel.hide();
                                    DevExpress.ui.notify("Có lỗi xảy ra: " + errorThrown, "error", 3000);
                                }
                            });
                        }
                        return deferred.promise();
                    }
                });
                $(document).on('click', '#acceptence', function (e) {
                    e.preventDefault();
                    var formdata = $('#form-maintenancelog-detail').dxForm("instance").option('formData');
                    var files = $("#file-uploader").dxFileUploader("instance").option("value");

                    var fileWrappers = fileUploader()._files;
                    var resValid = true
                    if (!resValid) {
                        DevExpress.ui.notify("Vui lòng kiểm tra lại file đính kèm!", "error", 3000);
                    }
                    else {
                        loadingPanel.show();
                        var deferred = $.Deferred();
                        formdata.status = 200;
                        formdata.maintenanceScheduleId = rs[0].maintenanceScheduleId;
                        formdata.maintenancerInfoId = rs[0].maintenancerInfoId;
                        var fdata = new FormData();
                        var i = 10;
                        $.each(formdata, function (key, value) {
                            fdata.append(key, value);
                        });
                        fdata.append('key', id);
                        fdata.append('token', UserCurrentInfo.accessToken);
                        var files = $("#file-uploader").dxFileUploader("instance").option("value");
                        if (files.length > 0) {
                            $.each(files, function (key, value) {
                                fdata.append(files[key].name, files[key]);
                            });
                        }
                        if (id > 0) {
                            $.ajax({
                                type: "POST",
                                enctype: 'multipart/form-data',
                                url: "/VanHanh/BaoTri/MaintenanceLogUpdate",
                                data: fdata,
                                processData: false,
                                contentType: false,
                                cache: false,
                                success: function (rs) {
                                    deferred.resolve(true);
                                    loadingPanel.hide();
                                    DevExpress.ui.notify(rs.result, rs.status, 3000);
                                    loadData_MaintenanceLogDetail(id);
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    loadingPanel.hide();
                                    DevExpress.ui.notify("Có lỗi xảy ra: " + errorThrown, "error", 3000);
                                }
                            });
                        }
                        return deferred.promise();
                    }
                });
            });
        };
        var fileUploader = () => $("#file-uploader").dxFileUploader({
            selectButtonText: "Chọn tập tin...",
            labelText: "Hoặc kéo thả vào đây",
            showFileList: true,
            multiple: true,
            uploadMode: "useForm",
            accept: ".jpg,.jpeg,.gif,.png,.pdf",
            allowedFileExtensions: [".jpg", ".jpeg", ".png", ".pdf"],
            maxFileSize: 52428800,
        }).dxFileUploader("instance");
    </script>
}

